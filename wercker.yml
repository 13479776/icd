# WERCKER_R_COVR_OPTIONS etc can also be set in the wercker configuration to do exclusions
box: rocker/hadleyverse
#box: jackwasey/r-devel-ubsan-gcc
command-timeout: 60
no-response-timeout: 60
build:
  steps:
    - install-packages:
        packages: r-cran-rodbc r-cran-codetools
    - script:
        name: icd test environment
        code: |
            export WERCKER_R_COVR_OPTIONS="path='.',expression('options(icd.do_slow_tests=TRUE)'),exclusions=list('inst/include/icd_RcppExports.h','R/RcppExports.R','src/RcppExports.cpp','R/benchmark.R')"
            # covr should be detected within package when it is tested, and shell env is not propogated to covr subprocess
            export ICD_ONLINE_TESTS=false
            export ICD_SLOW_TESTS=true
            rm .Rinstignore  # install everything for testing
            sed -i '/[Dd]ata/d' .Rbuildignore # do include data for testing
    - jimhester/r-dependencies:
        github_packages: kevinushey/rex jimhester/covr
#- hadley/testthat # in the throes
#- RcppCore/Rcpp # CRAN version up-to-date for my purposes
# try lint before check, so I get annotated github warnings before check fails
#    - jimhester/r-lint # lint currently has some strange bug, skip for now.
    - jimhester/r-check:
        warnings_are_errors: FALSE
# I think this has false positives for latex warnings, even if R CMD check is okay
#    - jackwasey/r-coverage
    - script:
        name: debug information before codecov with covr
        code: |
            ls -R
            echo $ICD_SLOW_TESTS
            cat ./icd.Rcheck/tests/test-all.Rout
# need my r-coverage so I can not be quiet with codecov call
    - jackwasey/r-coverage
    - script:
        name: debug information after codecov with covr
        code: |
            ls -R
            echo $ICD_SLOW_TESTS
            cat ./icd.Rcheck/tests/test-all.Rout
    - script:
        name: re-check with CRAN testthat
        code: |
            Rscript -e 'install.packages("testthat"); print(packageVersion("testthat"))'
    - jimhester/r-check:
        warnings_are_errors: FALSE
